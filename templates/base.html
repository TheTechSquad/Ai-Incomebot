<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AI INCOME - Crypto Mining Bot{% endblock %}</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Meta tags for mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2196F3">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block extra_head %}{% endblock %}
</head>
<body class="telegram-bg">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner">
            <i class="fas fa-coins fa-spin"></i>
        </div>
        <p>Loading AI INCOME...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="main-content hidden">
        {% block header %}
        <header class="app-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="AI INCOME">
                        <span>AI INCOME</span>
                    </div>
                    {% if user %}
                    <div class="user-balance">
                        <i class="fas fa-coins"></i>
                        <span>${{ "%.2f"|format(user.mined_hashes * 0.01) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </header>
        {% endblock %}

        <!-- Navigation -->
        {% block navigation %}
        <nav class="bottom-nav">
            <a href="/dashboard?tgWebAppData={{ request.args.get('tgWebAppData', '') }}" class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" onclick="startMining()" class="nav-item mine-btn">
                <i class="fas fa-pickaxe"></i>
                <span>Mine</span>
            </a>
            <a href="/shop?tgWebAppData={{ request.args.get('tgWebAppData', '') }}" class="nav-item {% if request.endpoint == 'shop' %}active{% endif %}">
                <i class="fas fa-store"></i>
                <span>Shop</span>
            </a>
            <a href="#" onclick="showStats()" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span>Stats</span>
            </a>
        </nav>
        {% endblock %}

        <!-- Main Content Area -->
        <main class="main-container">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Modals -->
    <div id="mining-modal" class="modal">
        <div class="modal-content">
            <div class="mining-animation">
                <i class="fas fa-cogs fa-spin"></i>
            </div>
            <h3>Mining in Progress...</h3>
            <div class="mining-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="mining-progress"></div>
                </div>
            </div>
            <p id="mining-status">Calculating hashes...</p>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Statistics</h3>
                <button class="close-btn" onclick="closeModal('stats-modal')" title="Close Statistics" aria-label="Close Statistics">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="stats-content" id="stats-content">
                <!-- Stats will be loaded here -->
            </div>
        </div>
    </div>

    <div id="success-modal" class="modal">
        <div class="modal-content success">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 id="success-title">Success!</h3>
            <p id="success-message"></p>
            <button class="btn btn-primary" onclick="closeModal('success-modal')">Continue</button>
        </div>
    </div>

    <div id="error-modal" class="modal">
        <div class="modal-content error">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Error</h3>
            <p id="error-message"></p>
            <button class="btn btn-secondary" onclick="closeModal('error-modal')">OK</button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Telegram Web App initialization (with fallback for browser viewing)
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            // Set theme colors
            document.documentElement.style.setProperty('--tg-theme-bg-color', window.Telegram.WebApp.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', window.Telegram.WebApp.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-button-color', window.Telegram.WebApp.themeParams.button_color || '#2196F3');
            
            // Get Telegram Web App data
            var tgData = window.Telegram.WebApp.initData;
        } else {
            // Browser fallback - no Telegram Web App available
            var tgData = '';
            console.log('Viewing in browser mode - Telegram Web App features disabled');
        }
        
        // Hide loading screen after a short delay
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-content').style.display = 'block';
        }, 1500);
        
        // Global functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showSuccess(title, message) {
            document.getElementById('success-title').textContent = title;
            document.getElementById('success-message').textContent = message;
            showModal('success-modal');
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            showModal('error-modal');
        }
        
        // API Helper function
        async function apiRequest(endpoint, data = {}) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...data,
                        init_data: tgData
                    })
                });
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }
        
        // Mining function
        async function startMining() {
            showModal('mining-modal');
            
            let progress = 0;
            const progressBar = document.getElementById('mining-progress');
            const statusText = document.getElementById('mining-status');
            
            // Animate progress
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                
                if (progress < 30) {
                    statusText.textContent = 'Initializing GPU cores...';
                } else if (progress < 60) {
                    statusText.textContent = 'Processing hash algorithms...';
                } else if (progress < 90) {
                    statusText.textContent = 'Validating blockchain data...';
                } else {
                    statusText.textContent = 'Finalizing results...';
                }
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    processMining();
                }
            }, 100);
        }
        
        async function processMining() {
            try {
                const result = await apiRequest('/api/mine');
                
                closeModal('mining-modal');
                
                if (result.success) {
                    showSuccess(
                        'Mining Successful!', 
                        `You earned ${result.hashes_earned.toFixed(6)} hashes worth $${(result.hashes_earned * 0.01).toFixed(2)}!`
                    );
                    
                    // Update UI with new values
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showError(result.error || 'Mining failed');
                }
            } catch (error) {
                closeModal('mining-modal');
                showError('Network error occurred');
            }
        }
        
        // Stats function
        async function showStats() {
            try {
                const result = await apiRequest('/api/stats');
                
                if (result.error) {
                    showError(result.error);
                    return;
                }
                
                document.getElementById('stats-content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <i class="fas fa-bolt"></i>
                            <span class="stat-label">GPU Power</span>
                            <span class="stat-value">${result.gpu_power.toLocaleString()}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-coins"></i>
                            <span class="stat-label">Total Hashes</span>
                            <span class="stat-value">${result.total_hashes.toFixed(6)}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span class="stat-label">USDT Value</span>
                            <span class="stat-value">$${result.usdt_value.toFixed(2)}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-calendar"></i>
                            <span class="stat-label">Daily Estimate</span>
                            <span class="stat-value">$${result.daily_estimate.toFixed(2)}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-link"></i>
                            <span class="stat-label">Referral Code</span>
                            <span class="stat-value">${result.referral_code}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-user-clock"></i>
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value">${result.member_since}</span>
                        </div>
                    </div>
                `;
                
                showModal('stats-modal');
            } catch (error) {
                showError('Failed to load statistics');
            }
        }
        
        // Haptic feedback for buttons (Telegram Web App feature)
        document.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('.btn') || e.target.closest('.nav-item')) {
                if (window.Telegram.WebApp.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
            }
        });
    </script>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>